<html>

<body>

  <canvas id="canvasEl"></canvas>

  <script src="./bower_components/ydn.db/jsc/ydn.db-dev.js"></script>
  <script>
    var log = console.log.bind(console);
    var debug = console.log.bind(console, 'DEBUG');
    var info = console.log.bind(console, 'INFO');

    var file_schema = {
      stores: [{
        name: 'file',
        type: 'TEXT' // data type of 'file' object store key
      }]
    };

    db = new ydn.db.Storage('file-test-1', file_schema);

    function saveAsBase64(url, cb) {
      var xhr = new XMLHttpRequest();
      xhr.responseType = 'blob';
      xhr.onload = function() {
        var reader = new FileReader();
        reader.onloadend = function() {
          db.put('file', {
            data: reader.result
          }, 'base64').done(function(key) {
            if (cb) cb(key);
          });
        }
        reader.readAsDataURL(xhr.response);
      };
      xhr.open('GET', url);
      xhr.send();
    }

    function displayB64Image(data) {
      var canvas = document.getElementById("canvasEl");
      var ctx = canvas.getContext("2d");
      var image = new Image();
      image.onload = function() {
        ctx.drawImage(image, 0, 0);
      };
      image.src = data;
      canvas.height = 900;
      canvas.width = 900;
    }

    function showBase64() {
      db.get('file', 'base64').done(function(res) {
        displayB64Image(res.data);
      }, function(e) {
        log(e.message || e);
      });
    }

    // thenable version of `xhr`
    var xhr = function(url, method, data, user, password) {
      return new Promise(function(fulfill, reject) {

        var messageToLog = function(evt) {
          var msg = 'Event occured: ' + JSON.stringify(evt) + '. ';
          msg += 'Current status: ' + req.status + '. ';
          msg += 'Current responseText: ' + req.responseText + '. ';
          msg += 'getAllResponseHeaders: ' + req.getAllResponseHeaders() + '. ';
          return msg;
        };

        var req = new XMLHttpRequest();
        var updateProgress, transferComplete, transferFailed, transferCanceled;
        updateProgress = transferCanceled = transferFailed =
          function(evt) {
            log('xht:transferCanceled/transferFailed' + messageToLog(evt), 'ERROR');
          };

        transferComplete = function(evt) {
          if (req.status !== 200) {
            log('xhr:transferComplete' + messageToLog(evt), 'ERROR',
              'STATUS_' + req.status);
            reject({
              status: req.status,
              data: req.responseText
            });
            return;
          }

          var responseData = req.responseText;

          // Try to convert response to JSON
          try {
            responseData = JSON.parse(req.responseText)
          } catch (e) {
            info('xhr:transferComplete:response is not JSON, will return string');
          }

          debug('xhr:transferComplete with status 200', 'STATUS_' + req.status, responseData);

          fulfill({
            status: req.status,
            data: responseData
          });
        };

        //req.addEventListener("progress", updateProgress, false);
        req.addEventListener("load", transferComplete, false);
        req.addEventListener("error", transferFailed, false);
        req.addEventListener("abort", transferCanceled, false);

        try {
          debug('xhr:url ' + url,
            ', user: ' + user, ' and password: ' + password,
            ', method: ' + method,
            ', data: ', data);

          if (!method) method = 'GET';
          if (!url) url = rehect('ERROR: url is mandatory!');

          req.open(method, url, true);

          if (user && password) {
            req.withCredentials = true;
            req.setRequestHeader('user', user);
            req.setRequestHeader('password', password);
          }

          if (data && typeof data !== 'string') req.send(JSON.stringify(data));
          else if (data) req.send(data);
          else req.send();

        } catch (e) {
          log('xhr:Error in server request: ', e, 'request status', req.status);
          reject(e);
        }
      });
    };

    function sendBase64() {
      db.get('file', 'base64').done(function(res) {
        xhr('http://localhost:3000', 'POST', res.data);
      }, function(e) {
        log(e.message || e);
      });
    }

    // Call two functions with the same arguments
    var P = function(f, g) {
      return function() {
        f.apply(this, arguments);
        g.apply(this, arguments);
      };
    };

    url = 'http://www.gizur.com/img/projektledning_w767.png';
    saveAsBase64(url, P(showBase64, sendBase64));

  </script>

</body>

</html>
